# çŸ­é“¾æ¥ï¼ˆShort Linkï¼‰æœåŠ¡ â€” Nuxt 3 + Redis

ä¸€ä¸ª**é«˜æ€§èƒ½ / é«˜å¯ç”¨**çš„çŸ­é“¾æ¥ç”ŸæˆæœåŠ¡ï¼Œä½¿ç”¨ **Nuxt 3 (Nitro)** æä¾› RESTful API ä¸æ ¹è·¯å¾„é‡å®šå‘ï¼Œä½¿ç”¨ **Redis** ä½œä¸ºæŒä¹…åŒ–ä¸å¹¶å‘æ§åˆ¶åŸºç¡€ã€‚

---

## âœ¨ åŠŸèƒ½æ¦‚è§ˆ

- `POST /v1/links`ï¼šåˆ›å»ºçŸ­é“¾æ¥  
  - è¯·æ±‚ä½“ï¼š`{ "url": "https://a-very-long-url.com/with/path?and=query" }`  
  - æˆåŠŸï¼š`{ "short_code": "aK3nLp7", "short_url": "http://example.domain/aK3nLp7" }`  
  - å¤±è´¥ï¼š
    - `400 Bad Request` URL æ— æ•ˆ
    - `429 Too Many Requests` è§¦å‘ IP çº§é™æµï¼ˆé»˜è®¤ 1 åˆ†é’Ÿ 10 æ¬¡ï¼‰
    - `500 Internal Server Error` æœåŠ¡å†…éƒ¨é”™è¯¯
- `GET /:short_code`ï¼šæ ¹æ®çŸ­ç  301/302 é‡å®šå‘åˆ°åŸå§‹é•¿é“¾æ¥ï¼ˆæœ¬å®ç°ä½¿ç”¨ `302 Found`ï¼‰ã€‚  
  - æ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼š`404 Not Found`

---

## ğŸ—ï¸ æœ¬åœ°ç¯å¢ƒæ­å»º & å¯åŠ¨

### 1) å…‹éš† & å®‰è£…
```bash
# å®‰è£…ä¾èµ–
pnpm i   # æˆ– npm i / yarn
```

### 2) å¯åŠ¨ Redisï¼ˆæ¨èç”¨ Dockerï¼‰
```bash
docker compose up -d
# Redis ç›‘å¬ 6379 ç«¯å£ï¼Œå¹¶å¼€å¯ AOF æŒä¹…åŒ–
```

### 3) ç¯å¢ƒå˜é‡
å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶æŒ‰éœ€è°ƒæ•´ï¼š
```env
REDIS_URL=redis://localhost:6379
BASE_URL=http://localhost:3000
CODE_SECRET=è¯·æ”¹æˆå¼ºéšæœºå¯†é’¥
```

### 4) å¯åŠ¨æœåŠ¡
```bash
pnpm dev   # æˆ– npm run dev / yarn dev
```
- å¼€å‘æ¨¡å¼é»˜è®¤ç«¯å£ï¼š`http://localhost:3000`

### 5) ç¤ºä¾‹è¯·æ±‚
```bash
curl -X POST http://localhost:3000/v1/links \
  -H "Content-Type: application/json" \
  -d '{"url":"https://example.com/hello?x=1"}'
# => {"short_code":"Ab12cD3","short_url":"http://localhost:3000/Ab12cD3"}
```

---

## ğŸ§® çŸ­ Code ç”Ÿæˆç®—æ³• & å†²çªå¤„ç†

### ç›®æ ‡
- é•¿åº¦ **6-8** ä½ï¼ˆé»˜è®¤ 7ï¼‰ï¼Œå­—ç¬¦é›† **[0-9a-zA-Z]**ã€‚
- éé€’å¢ã€ä¸å¯é¢„æµ‹ï¼ˆé¿å…ä¿¡æ¯æ³„éœ² & æ‰«ç æšä¸¾ï¼‰ã€‚
- **é«˜å¹¶å‘**ä¸‹ä»èƒ½**ç»å¯¹å”¯ä¸€**ã€‚

### ç®—æ³•
1. ä½¿ç”¨ **HMAC-SHA256**ï¼ˆå¯†é’¥ `CODE_SECRET`ï¼‰å¯¹ï¼š`longUrl + å½“å‰æ—¶é—´æˆ³ + é‡è¯•è®¡æ•°` è¿›è¡Œæ‘˜è¦ï¼›
2. å°†æ‘˜è¦å­—èŠ‚è½¬ä¸º **Base62** å­—ç¬¦ä¸²ï¼›
3. æˆªæ–­/å¡«å……åˆ°æŒ‡å®šé•¿åº¦ï¼ˆé»˜è®¤ 7 ä½ï¼ŒåŒºé—´ 6~8ï¼‰ï¼›
4. é€šè¿‡ **Redis Lua è„šæœ¬**æ‰§è¡Œ**åŸå­å†™å…¥**ï¼š
   - `SETNX sl:{code} -> longUrl`ï¼ˆåŸå­ï¼šè‹¥å·²å­˜åœ¨åˆ™å¤±è´¥ï¼‰
   - å¯é€‰å»ºç«‹**åå‘ç´¢å¼•** `url:{hash} -> {code}`ï¼ˆç”¨äº**å»é‡**ï¼šåŒ URL è¿”å›åŒä¸€çŸ­ç ï¼‰ã€‚

### å†²çª/ç¢°æ’å¤„ç†
- è‹¥ `sl:{code}` å·²å­˜åœ¨ï¼Œåˆ™**é‡è¯•**ï¼ˆæ›´æ¢æ—¶é—´æˆ³/è®¡æ•°ï¼‰æœ€å¤š N æ¬¡ï¼ˆé»˜è®¤ 5~7 æ¬¡ï¼‰ã€‚
- **Lua è„šæœ¬**ä¿è¯æ•´ä¸ªâ€œå†™å…¥çŸ­ç  + å»ºåå‘ç´¢å¼•â€çš„**åŸå­æ€§**ï¼Œé¿å…å¹¶å‘ç«æ€ã€‚
- ç†è®ºä¸Š 62^7 â‰ˆ 3.5e12 ä¸ªç©ºé—´ï¼Œç¢°æ’æ¦‚ç‡æä½ï¼›ç»“åˆ HMAC éšæœºæ€§ä¸é‡è¯•ï¼Œç¢°æ’å¯å¿½ç•¥ã€‚

> ä»£ç ä½ç½®ï¼š`server/utils/codegen.ts`ã€`server/utils/base62.ts`

---

## ğŸ—ƒï¸ æ•°æ®å­˜å‚¨ï¼ˆé€‰æ‹© Redis çš„åŸå› ï¼‰

é€‰æ‹© **Redis** çš„æ ¸å¿ƒç†ç”±ï¼š
1. **é«˜æ€§èƒ½**ï¼šå†…å­˜çº§è¯»å†™ï¼Œæ”¯æŒç™¾ä¸‡ QPS é‡çº§ã€‚
2. **åŸå­æ€§**ï¼šLua è„šæœ¬/äº‹åŠ¡å¯åœ¨é«˜å¹¶å‘ä¸‹å®ç°å¼ºä¸€è‡´å†™å…¥ã€‚
3. **æ˜“æ°´å¹³æ‰©å±•**ï¼šå¯ä½¿ç”¨ Redis Cluster æˆ–è€…ä¸»ä» + å“¨å…µã€‚
4. **æŒä¹…åŒ–å¯é€‰**ï¼šAOF/RDB æä¾›å®¹ç¾èƒ½åŠ›ï¼ˆæœ¬ç¤ºä¾‹ç”¨ AOFï¼‰ã€‚
5. **é€Ÿç‡é™åˆ¶**ã€**å»é‡**ã€**å”¯ä¸€æ€§æ£€æŸ¥**éƒ½å¯åœ¨ Redis å†…ä¸€ç«™å¼å®Œæˆã€‚

### Key è®¾è®¡ï¼ˆSchemaï¼‰

> Redis ä¸º KV å­˜å‚¨ï¼Œæ— ä¼ ç»Ÿè¡¨/ç´¢å¼•æ¦‚å¿µã€‚ä»¥ä¸‹ä¸ºçº¦å®šçš„ Key ç»“æ„ï¼š

- `sl:{code}` â†’ `longUrl`  
  - **ä½œç”¨**ï¼šçŸ­ç æŸ¥åŸå§‹ URLï¼ˆä¸»ç´¢å¼•ï¼‰  
  - **TTL**ï¼šé»˜è®¤æ— ï¼ˆæ°¸ä¹…ï¼‰ã€‚å¦‚éœ€ä¸´æ—¶é“¾æ¥å¯è®¾ç½® `ttlMs`ã€‚
- `url:{sha256(longUrl)}` â†’ `{code}`  
  - **ä½œç”¨**ï¼šåŒ URL å»é‡ï¼ˆé¿å…é‡å¤åˆ›å»ºä¸åŒçŸ­ç ï¼‰  
  - **TTL**ï¼šå»ºè®®ä¸çŸ­ç ä¸€è‡´ã€‚
- `rl:{ip}:{windowStart}` â†’ è®¡æ•°  
  - **ä½œç”¨**ï¼šé™æµè®¡æ•°ï¼ŒæŒ‰çª—å£ç²’åº¦ï¼ˆå¦‚ 60sï¼‰è‡ªåŠ¨è¿‡æœŸ

> **ç´¢å¼•**ï¼šRedis çš„â€œç´¢å¼•â€å³ Key æœ¬èº«ã€‚çŸ­ç ä¸ URL çš„æŸ¥æ‰¾éƒ½æ˜¯ `O(1)`ã€‚

---

## ğŸš¦ é€Ÿç‡é™åˆ¶ï¼ˆIP çº§ï¼‰

- **ç­–ç•¥**ï¼šå›ºå®šçª—å£è®¡æ•°ï¼ˆFixed Window Counterï¼‰
  - åŒä¸€ IPï¼Œ`1 åˆ†é’Ÿ` å†…æœ€å¤š `10` æ¬¡ã€‚
  - å®ç°ï¼š`INCR rl:{ip}:{minute}`ï¼Œåˆæ¬¡è®¾ç½® `EXPIRE 60`ã€‚
- **è¿”å›**ï¼šè¶…é™è¿”å› `429 Too Many Requests`ã€‚
- å¯æ›¿æ¢ä¸º **æ»‘åŠ¨çª—å£/æ¼æ¡¶/ä»¤ç‰Œæ¡¶**ä»¥è·å¾—æ›´å¹³æ»‘çš„é™æµã€‚

> ä»£ç ä½ç½®ï¼š`server/utils/rate-limit.ts`

---

## ğŸ”Œ API è®¾è®¡

### `POST /v1/links`
- **è¯·æ±‚ä½“**ï¼š
  ```json
  { "url": "https://a-very-long-url.com/with/path?and=query" }
  ```
- **æˆåŠŸ (200 OK / 201 Created)**ï¼š
  ```json
  { "short_code": "aK3nLp7", "short_url": "http://example.domain/aK3nLp7" }
  ```
- **å¤±è´¥**ï¼š
  - `400 Bad Request`ï¼šURL æ ¼å¼é”™è¯¯/ç¼ºå­—æ®µ
  - `429 Too Many Requests`ï¼šè¶…å‡ºé€Ÿç‡é™åˆ¶
  - `500 Internal Server Error`ï¼šæœåŠ¡å¼‚å¸¸

> è·¯ç”±å®ç°ï¼š`server/routes/v1/links.post.ts`ï¼ˆNitro è·¯ç”±ä¸å¸¦ `/api` å‰ç¼€ï¼Œå³å®é™…è·¯å¾„å°±æ˜¯ `/v1/links`ï¼‰

### `GET /:short_code`
- çŸ­ç æ ¡éªŒï¼š`^[0-9A-Za-z]{6,8}$`
- æŸ¥æ‰¾ `sl:{code}`ï¼Œå­˜åœ¨åˆ™ `302 Found` è·³è½¬ï¼›å¦åˆ™ `404`ã€‚
- å¦‚éœ€ **301 æ°¸ä¹…è·³è½¬**ï¼Œå°† `setResponseStatus` æ”¹ä¸º `301` å³å¯ã€‚

> è·¯ç”±å®ç°ï¼š`server/routes/[short_code].get.ts`

---

## ğŸ” å®‰å…¨æ€§è€ƒé‡

- **URL æ ¡éªŒ**ï¼šä»…å…è®¸ `http/https`ï¼Œç¦æ­¢ `localhost` ç­‰å†…éƒ¨åœ°å€ï¼Œå‡è½» SSRF é£é™©ã€‚
- **ä¸å¯é¢„æµ‹çŸ­ç **ï¼šHMAC åŠ éšæœºç†µï¼Œé¿å…è¢«é¡ºåºæšä¸¾ã€‚
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ»¥ç”¨/æ’åº“ã€‚
- **æœºå¯†ç®¡ç†**ï¼š`CODE_SECRET` å¿…é¡»åœ¨ç”Ÿäº§ä¸­å¦¥å–„ä¿ç®¡ã€‚

---

## âš™ï¸ å…³é”®é…ç½®ä½ç‚¹

- çŸ­ç é•¿åº¦ä¸é‡è¯•ï¼š`server/utils/codegen.ts`
- é™æµçª—å£ä¸é˜ˆå€¼ï¼š`server/utils/rate-limit.ts` / `v1/links.post.ts`
- æ°¸ä¹…/ä¸´æ—¶çŸ­é“¾ TTLï¼šä¼ å…¥ `ttlMs` å³å¯å¼€å¯ä¸´æ—¶çŸ­é“¾ã€‚

---

## ğŸ“ˆ æ¨ªå‘æ‰©å±•å»ºè®®

- **å¤šå®ä¾‹**åº”ç”¨ï¼šRedis ä½œä¸ºé›†ä¸­å¼åè°ƒå™¨ï¼Œå®ä¾‹æ— çŠ¶æ€æ°´å¹³æ‰©å±•ã€‚
- **Redis Cluster**ï¼šåˆ†ç‰‡æ‰©å®¹ï¼›æˆ–ä¸»ä» + å“¨å…µæå‡å¯ç”¨æ€§ã€‚
- **çƒ­ç‚¹ä¿æŠ¤**ï¼šä¸ºçˆ†æ¬¾çŸ­ç æ·»åŠ æœ¬åœ° LRU ç¼“å­˜ï¼ˆä¾‹å¦‚ node-cacheï¼‰å‡å°‘å›æºã€‚

---

## ğŸ§ª å¥åº·æ£€æŸ¥ & ç›‘æ§

- å¢åŠ  `GET /healthz`ï¼ˆæ­¤å¤„ç•¥ï¼‰æ£€æŸ¥ Redis è¿æ¥ä¸è„šæœ¬åŠ è½½ã€‚
- ç›‘æ§ï¼šè¯·æ±‚é‡ã€4xx/5xxã€Redis QPSã€å†…å­˜ä¸ AOF å¤§å°ã€‚

---

## ğŸ§± (å¯é€‰) SQL ç‰ˆæœ¬å‚è€ƒ DDL

å¦‚æœé€‰ç”¨ MariaDB/MySQLï¼Œå¯ç”¨å¦‚ä¸‹ DDLï¼ˆä»…ä½œå‚è€ƒï¼‰ï¼š
```sql
CREATE TABLE short_links (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  short_code CHAR(8) NOT NULL UNIQUE,
  long_url TEXT NOT NULL,
  url_hash CHAR(64) NOT NULL UNIQUE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_short_code ON short_links(short_code);
CREATE UNIQUE INDEX idx_url_hash ON short_links(url_hash);
```

---

## ğŸ“‚ ç›®å½•ç»“æ„

```
shortlink-nuxt/
â”œâ”€ app.vue
â”œâ”€ docker-compose.yml
â”œâ”€ nuxt.config.ts
â”œâ”€ package.json
â”œâ”€ .env.example
â”œâ”€ server/
â”‚  â”œâ”€ routes/
â”‚  â”‚  â”œâ”€ v1/
â”‚  â”‚  â”‚  â””â”€ links.post.ts         # POST /v1/links
â”‚  â”‚  â””â”€ [short_code].get.ts      # GET /:short_code
â”‚  â””â”€ utils/
â”‚     â”œâ”€ base62.ts
â”‚     â”œâ”€ codegen.ts
â”‚     â”œâ”€ rate-limit.ts
â”‚     â”œâ”€ redis.ts
â”‚     â””â”€ validate.ts
â””â”€ README.md
```

---

## âœ… è¿è¡Œè¦ç‚¹å›é¡¾

- ä½¿ç”¨ `docker compose up -d` å¯åŠ¨ Redisï¼ˆAOF æŒä¹…åŒ–ï¼‰ã€‚
- è®¾ç½® `.env` ä¸­çš„ `BASE_URL` ä¸ `CODE_SECRET`ã€‚
- è¿è¡Œ `pnpm dev` å¯åŠ¨ Nuxtã€‚

ç¥ä½ æœºè¯•é¡ºåˆ©ï¼
